<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Manager v14 - Fix Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --background-dark: #121417; --container-bg: #22252A; --header-bg: #2D2F3E;
            --element-bg: #3A3D4D; --element-bg-hover: #4a4e5a; --primary-accent: #007BFF;
            --primary-accent-dark: #0056b3; --text-primary: #FFFFFF; --text-secondary: #E0E0E0;
            --text-muted: #9E9E9E; --border-color: #3A3D4D; --star-yellow: #FFC107;
            --btn-green: #28a745; --btn-red: #dc3545;
        }
        [data-theme="light"] {
            --background-dark: #F5F5F5; --container-bg: #FFFFFF; --header-bg: #E3E6F0;
            --element-bg: #F8F9FA; --element-bg-hover: #E9ECEF; --primary-accent: #0066CC;
            --text-primary: #212529; --text-secondary: #495057; --border-color: #DEE2E6;
            --star-yellow: #FFC107; 
        }
        * { box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--background-dark); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; color: var(--text-primary); display: flex; flex-direction: column; }
        .app-header { background-color: var(--header-bg); border-radius: 16px; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,.2); margin-bottom: 20px; flex-shrink: 0; }
        .header-left, .header-center, .header-right { display: flex; align-items: center; gap: 16px; }
        .logo { color: var(--text-primary); font-size: 28px; font-weight: bold; }
        .search-bar { display: flex; align-items: center; background-color: var(--element-bg); border-radius: 12px; padding: 0 15px; }
        .search-bar input { background: transparent; border: none; outline: none; color: var(--text-primary); padding: 12px 10px; font-size: 16px; width: 280px; }
        .category-dropdown-container { display: flex; align-items: center; background-color: var(--element-bg); border-radius: 12px; padding: 0 15px; }
        #category-dropdown { background: transparent; border: none; outline: none; color: var(--text-primary); padding: 12px 0; font-size: 16px; width: 220px; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; }
        #category-dropdown option { background-color: var(--container-bg); color: var(--text-primary); }
        .tool-button { background-color: #7A69E9; color: #FFFFFF; border: none; border-radius: 12px; padding: 10px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .theme-toggle { background-color: var(--element-bg); color: var(--text-primary); border: none; border-radius: 12px; padding: 10px 16px; font-size: 18px; cursor: pointer; }
        .header-right { position: relative; }
        .toolbar-dropdown-menu { display: none; position: absolute; top: 110%; right: 0; background-color: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; z-index: 1000; width: 360px; box-shadow: 0 8px 16px rgba(0,0,0,.4); grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .toolbar-dropdown-menu.show { display: grid; }
        .toolbar-btn { color: white; border: none; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; text-align: center; min-height: 70px; }
        .toolbar-btn:disabled { background-color: #555 !important; cursor: not-allowed; opacity: .5; }
        .btn-green { background-color: var(--btn-green); } .btn-yellow { background-color: #f7b731; color: #333; } .btn-blue { background-color: #007bff; } .btn-dark-blue { background-color: #0d47a1; } .btn-red { background-color: var(--btn-red); }
        
        main { display: grid; gap: 20px; flex-grow: 1; min-height: 0; }
        main.view-mode-three-column { grid-template-columns: 320px 320px 1fr; }
        main.view-mode-two-column { grid-template-columns: 400px 1fr; }

        .column { background-color: var(--container-bg); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--element-bg); padding-bottom: 10px; flex-shrink: 0; }
        .column-header h3 { margin: 0; font-size: 18px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .column-content { overflow-y: auto; padding-right: 10px; margin-right: -10px; }
        .column-content::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-thumb { background-color: var(--element-bg); border-radius: 20px; }
        .add-button { background-color: var(--btn-green); color: white; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; }
        .item-container { display: flex; flex-direction: column; align-items: flex-start; padding: 12px; background-color: var(--element-bg); border-radius: 6px; margin-bottom: 8px; color: var(--text-secondary); border-left: 3px solid transparent; cursor: pointer; }
        .item-container:hover { background-color: var(--element-bg-hover); }
        .item-container.active { background-color: var(--primary-accent-dark); border-left-color: var(--star-yellow); color: white; }
        .item-name { font-weight: 500; margin-bottom: 4px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-path { font-size: 12px; color: var(--text-muted); }
        .item-container.active .item-path { color: #ddd; }
        
        #col-detail, #col-special-detail { padding: 0; }
        .prompt-detail-view { height: 100%; display: flex; flex-direction: column; }
        .prompt-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0;}
        .prompt-actions-toolbar { display: flex; gap: 15px; }
        .prompt-actions-toolbar i { cursor: pointer; font-size: 18px; }
        .prompt-actions-toolbar .fa-star.fa-solid { color: var(--star-yellow); }
        .prompt-title-section { display: flex; align-items: center; gap: 15px; padding: 15px 20px; }
        .prompt-title-section h1 { margin: 0; font-size: 24px; color: var(--text-primary); }
        #formatting-toolbar { padding: 10px 20px; display: none; gap: 8px; align-items: center; flex-wrap: wrap; background-color: var(--element-bg); border-bottom: 1px solid var(--border-color); }
        #formatting-toolbar.show { display: flex; }
        #formatting-toolbar button { 
            background: var(--element-bg-hover); 
            border: none; 
            color: var(--text-primary); 
            padding: 8px 12px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #formatting-toolbar button:hover { background: var(--primary-accent-dark); }
        #btnSaveChanges { background-color: var(--primary-accent); display: none; margin-left: auto; color: #FFFFFF; }
        #btnSaveChanges.show { display: inline-block; }
        .prompt-description-container { padding: 20px; line-height: 1.7; flex-grow: 1; overflow-y: auto; min-height: 0; }
        .prompt-description-container:focus { outline: none; }
        .prompt-description-container[contenteditable="true"] { outline: 2px dashed var(--primary-accent); }
        .initial-message { text-align: center; color: var(--text-muted); font-size: 16px; padding: 20px; height: 100%; display: flex; align-items: center; justify-content: center; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--container-bg); border-left: 4px solid var(--primary-accent); padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.3); }
        .toast.error { border-left-color: var(--btn-red); } .toast.success { border-left-color: var(--btn-green); }
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .loading-spinner i { font-size: 48px; color: var(--primary-accent); animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Stili Drag & Drop */
        .prompt-description-container[contenteditable="true"].drag-over {
            outline: 3px dashed var(--star-yellow);
            background-color: rgba(255, 193, 7, 0.1);
        }

        /* Stile specifico per i link: li rendiamo arancioni accesi e cliccabili */
        .prompt-description-container a {
            color: #FFA500;
            text-decoration: underline;
            cursor: pointer;
        }
        .prompt-description-container a:hover {
            color: #FF8C00;
            text-decoration: underline;
        }

        /* --- STILI MODAL URL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center; align-items: center;
            z-index: 10001;
        }

        .modal-content {
            background-color: var(--container-bg);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-content h4 {
            margin-top: 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.25rem;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 15px 0 25px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--element-bg);
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }
        
        .modal-content input[type="text"]:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-btn.cancel {
            background-color: var(--element-bg-hover);
            color: var(--text-secondary);
        }

        .modal-btn.confirm {
            background-color: var(--primary-accent);
            color: white;
        }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay"><div class="loading-spinner"><i class="fa-solid fa-spinner"></i></div></div>

<!-- MODAL PER INSERIMENTO URL -->
<div class="modal-overlay" id="linkModal">
    <div class="modal-content">
        <h4>Inserisci l'URL del Link</h4>
        <input type="text" id="linkUrlInput" placeholder="Es: https://www.google.it" value="">
        <div class="modal-actions">
            <button class="modal-btn cancel" id="linkModalCancel">Annulla</button>
            <button class="modal-btn confirm" id="linkModalConfirm">Conferma</button>
        </div>
    </div>
</div>
<!-- FINE MODAL -->

<header class="app-header">
    <div class="header-left"><div class="logo">PS</div></div>
    <div class="header-center">
        <div class="search-bar">
             <i class="fa-solid fa-magnifying-glass"></i>
             <input type="text" id="search-input" placeholder="Cerca...">
        </div>
        <div class="category-dropdown-container">
            <i class="fa-solid fa-list"></i>
            <select id="category-dropdown" title="Seleziona una categoria"></select>
        </div>
    </div>
    <div class="header-right">
        <button class="theme-toggle" id="themeToggle" title="Cambia tema"><i class="fa-solid fa-moon"></i></button>
        <button class="tool-button" id="toolBtn"><i class="fa-solid fa-screwdriver-wrench"></i><span>Tool</span></button>
        <div class="toolbar-dropdown-menu" id="toolMenu">
            <button class="toolbar-btn btn-green" id="btnAddCategory"><i class="fa-solid fa-plus"></i><span>Aggiungi Categoria</span></button>
            <button class="toolbar-btn btn-yellow" id="btnAnnulla"><i class="fa-solid fa-arrow-rotate-left"></i><span>Annulla</span></button>
            <button class="toolbar-btn btn-yellow" id="btnRipristina"><i class="fa-solid fa-arrow-rotate-right"></i><span>Ripristina</span></button>
            <button class="toolbar-btn btn-blue" id="btnBackup"><i class="fa-solid fa-download"></i><span>Backup</span></button>
            <button class="toolbar-btn btn-dark-blue" id="btnImporta"><i class="fa-solid fa-upload"></i><span>Importa</span></button>
        </div>
    </div>
</header>
<input type="file" id="backupInput" style="display:none" accept=".json">
<input type="file" id="imageInput" style="display:none" accept="image/*">

<main id="main-content-area"></main>

<script>
(async () => {
    // --- SYSTEMS ---
    const Loader = { el: document.getElementById('loading-overlay'), show() { this.el.style.display = 'flex'; }, hide() { this.el.style.display = 'none'; } };
    const Toast = { container: document.getElementById('toast-container'), show(message, type = 'info', duration = 3000) { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; this.container.appendChild(t); setTimeout(() => t.remove(), duration); } };
    const Database = { DB_NAME: "PromptManagerDB_v14_Fixed", STORE_NAME: "promptsData", db: null, async init() { return new Promise((resolve, reject) => { const r=indexedDB.open(this.DB_NAME, 1); r.onerror=reject; r.onsuccess=e=>{this.db=e.target.result;resolve();}; r.onupgradeneeded=e=>e.target.result.createObjectStore(this.STORE_NAME, {keyPath:"id"}); }); }, async save(data) { return new Promise((resolve, reject) => { const tx=this.db.transaction([this.STORE_NAME],"readwrite"); tx.objectStore(this.STORE_NAME).put({id:"main",data}); tx.oncomplete=resolve; tx.onerror=reject; }); }, async load() { return new Promise((resolve, reject) => { const r=this.db.transaction([this.STORE_NAME]).objectStore(this.STORE_NAME).get("main"); r.onsuccess=e=>resolve(e.target.result?e.target.result.data:[]); r.onerror=reject; }); } };
    function handlePaste(event) { event.preventDefault(); const text = event.clipboardData.getData('text/plain'); document.execCommand('insertText', false, text); }
    
    // --- STATE ---
    let state = { allData: [], history: [], redoStack: [], recents: [], currentView: 'columns', activeCategoryId: null, activeSubcategoryId: null, activePromptId: null };
    let savedRange = null;
    
    // --- DOM ELEMENTS ---
    const mainArea = document.getElementById("main-content-area");
    const categoryDropdown = document.getElementById("category-dropdown");
    const imageInput = document.getElementById('imageInput');

    // Elementi del Modal Link
    const linkModal = document.getElementById('linkModal');
    const linkUrlInput = document.getElementById('linkUrlInput');
    const linkModalConfirm = document.getElementById('linkModalConfirm');
    const linkModalCancel = document.getElementById('linkModalCancel');

    // --- FUNZIONI MODAL LINK ---
    function showLinkModal() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && selection.toString().length > 0) {
            savedRange = selection.getRangeAt(0);
        } else {
             Toast.show("Seleziona il testo da trasformare in link.", 'error');
             return false;
        }

        linkUrlInput.value = '';
        linkModal.style.display = 'flex';
        setTimeout(() => linkUrlInput.focus(), 50);
        return true;
    }

    function hideLinkModal() {
        linkModal.style.display = 'none';
        savedRange = null;
    }
    
    function applyLink(url) {
        if (!url || url.trim().length < 5) {
            Toast.show("URL non valido.", 'error');
            return;
        }
        
        let finalUrl = url.trim();
        if (!finalUrl.match(/^[a-zA-Z]+:\/\//)) {
            finalUrl = 'https://' + finalUrl;
        }

        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);

            const selectedText = savedRange.toString();
            const linkHtml = `<a href="${finalUrl}" target="_blank">${selectedText}</a>`;
            document.execCommand('insertHTML', false, linkHtml);
            
            document.querySelector('.prompt-description-container[contenteditable="true"]').focus();

            hideLinkModal();
            Toast.show("Link arancione creato con successo!", 'success', 2000);
        } else {
             Toast.show("Errore: Nessun testo selezionato.", 'error');
             hideLinkModal();
        }
    }

    // --- UTILS PER IMMAGINI ---
    function insertBase64Image(file) {
        if (!file.type.startsWith('image/')) {
            Toast.show("Il file non è un'immagine.", 'error');
            return;
        }
        if (file.size > 2 * 1024 * 1024) {
            Toast.show("Immagine troppo grande (Max 2MB).", 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const descriptionContainer = document.querySelector('.prompt-description-container[contenteditable="true"]');
            if (!descriptionContainer) return;
            
            const imgHtml = `<img src="${e.target.result}" style="max-width: 100%; height: auto; display: block; margin: 10px 0; border-radius: 8px;" alt="Immagine allegata al prompt">`;
            
            document.execCommand('insertHTML', false, imgHtml);
            descriptionContainer.focus();
            Toast.show("Immagine inserita (Base64).", 'success', 2000);
        };
        reader.readAsDataURL(file);
    }

    // --- CORE LOGIC ---
    async function updateStateAndSave(newData, { newActiveIds = {}, saveHistory = true } = {}) {
        Loader.show();
        if (saveHistory) { state.redoStack = []; state.history.push(JSON.parse(JSON.stringify({ ...state }))); if (state.history.length > 30) state.history.shift(); }
        state.allData = newData;
        Object.assign(state, newActiveIds);
        await Database.save(state.allData);
        localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents));
        renderUI();
        Loader.hide();
    }
    
    // --- RENDER FUNCTIONS ---
    function renderUI() {
        renderCategoryDropdown();
        switch(state.currentView) {
            case 'favorites': 
                mainArea.className = 'view-mode-two-column'; 
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`; 
                renderSpecialView('favorites'); 
                break;
            case 'recents': 
                mainArea.className = 'view-mode-two-column'; 
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`; 
                renderSpecialView('recents'); 
                break;
            default: 
                mainArea.className = 'view-mode-three-column'; 
                renderColumnsView(); 
                break;
        }
        updateUndoRedoButtons();
    }

    function renderColumnsView() {
        mainArea.innerHTML = `<div id="col-subcategories" class="column"></div> <div id="col-prompts" class="column"></div> <div id="col-detail" class="column"></div>`;
        renderSubcategoryColumn();
        renderPromptColumn();
        renderDetailColumn();
    }
    
    function renderCategoryDropdown() {
        categoryDropdown.innerHTML = "";
        const createOption = (value, text) => { const opt = document.createElement('option'); opt.value = value; opt.textContent = text; return opt; };
        
        categoryDropdown.appendChild(createOption('favorites', '⭐ Preferiti'));
        categoryDropdown.appendChild(createOption('recents', '🕒 Recenti'));
        if (state.allData.length > 0) {
            const separator = createOption('separator', '──────────'); separator.disabled = true; categoryDropdown.appendChild(separator);
            state.allData.sort((a,b)=>a.name.localeCompare(b.name)).forEach(category => categoryDropdown.appendChild(createOption(category.id, category.name)));
        }
        
        categoryDropdown.value = (state.currentView === 'favorites' || state.currentView === 'recents') ? state.currentView : state.activeCategoryId || '';

        if (state.currentView !== 'columns' && ['favorites', 'recents'].includes(state.currentView)) {
             categoryDropdown.value = state.currentView;
        } else if (state.activeCategoryId) {
            categoryDropdown.value = state.activeCategoryId;
        } else if (state.allData.length > 0) {
            categoryDropdown.value = state.allData[0].id;
        }
    }
    
    function renderSubcategoryColumn() {
        const col = document.getElementById('col-subcategories');
        const activeCategory = state.allData.find(c => c.id === state.activeCategoryId);
        if (!activeCategory) { col.innerHTML = '<div class="initial-message">Seleziona una categoria</div>'; return; }
        col.innerHTML = `<div class="column-header"><h3>${activeCategory.name}</h3><button class="add-button" id="add-subcat-btn" title="Aggiungi Sottocategoria"><i class="fa-solid fa-plus"></i> Sottocategoria</button></div><div class="column-content"></div>`;
        document.getElementById('add-subcat-btn').onclick = () => addSubcategory(activeCategory.id);
        const listContainer = col.querySelector('.column-content');
        if (!activeCategory.subcategories?.length) { listContainer.innerHTML = '<div class="initial-message">Nessuna sottocategoria</div>'; return; }
        activeCategory.subcategories.sort((a,b)=>a.name.localeCompare(b.name)).forEach(sub => { 
            const item = document.createElement("div"); 
            item.className = `item-container ${sub.id===state.activeSubcategoryId?'active':''}`; 
            item.innerHTML = `<span class="item-name">${sub.name}</span>`; 
            item.onclick = () => { 
                state.currentView = 'columns';
                state.activeSubcategoryId = sub.id; 
                state.activePromptId = sub.prompts?.sort((a,b)=>a.title.localeCompare(b.title))[0]?.id || null; 
                renderUI(); 
            }; 
            listContainer.appendChild(item); 
        });
    }

    function renderPromptColumn() {
        const col = document.getElementById('col-prompts');
        const activeSub = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId);
        if (!activeSub) { col.innerHTML = '<div class="initial-message">Seleziona una sottocategoria</div>'; return; }
        col.innerHTML = `<div class="column-header"><h3>${activeSub.name}</h3><button class="add-button" id="add-prompt-btn" title="Aggiungi Prompt"><i class="fa-solid fa-plus"></i> Prompt</button></div><div class="column-content"></div>`;
        
        // FIX: Binding corretto del pulsante
        const addPromptBtn = document.getElementById('add-prompt-btn');
        if (addPromptBtn) {
            addPromptBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                addNewPrompt(activeSub.id, state.activeCategoryId);
            };
        }
        
        const listContainer = col.querySelector('.column-content');
        if (!activeSub.prompts?.length) { listContainer.innerHTML = '<div class="initial-message">Nessun prompt</div>'; return; }
        activeSub.prompts.sort((a,b)=>a.title.localeCompare(b.title)).forEach(p => { 
            const item = document.createElement("div"); 
            item.className = `item-container ${p.id===state.activePromptId?'active':''}`; 
            item.innerHTML = `<div class="item-name">${p.title}</div>`; 
            item.onclick = () => { 
                state.activePromptId = p.id; 
                trackRecentPrompt(p.id, activeSub.id, state.activeCategoryId); 
                renderUI(); 
            }; 
            listContainer.appendChild(item); 
        });
    }

    function renderDetailColumn() {
        const colId = (state.currentView === 'favorites' || state.currentView === 'recents') ? 'col-special-detail' : 'col-detail';
        const col = document.getElementById(colId);
        if (!col) return;
        
        const cat = state.allData.find(c => c.id === state.activeCategoryId);
        const sub = cat?.subcategories.find(s => s.id === state.activeSubcategoryId);
        const promptItem = sub?.prompts.find(p => p.id === state.activePromptId);

        if (!promptItem) { col.innerHTML = '<div class="initial-message">Seleziona un prompt</div>'; return; }
        
        col.innerHTML = `
            <div class="prompt-detail-view">
                <div class="prompt-header"><h3>Dettagli Prompt</h3>
                    <div class="prompt-actions-toolbar">
                        <i id="edit-prompt-btn" class="fa-solid fa-pencil" title="Modifica"></i>
                        <i id="copy-prompt-btn" class="fa-solid fa-copy" title="Copia Testo"></i>
                        <i id="fav-prompt-btn" class="${promptItem.favorite ? "fa-solid" : "fa-regular"} fa-star" title="Preferito"></i>
                        <i id="delete-prompt-btn" class="fa-solid fa-trash-can" title="Elimina"></i>
                    </div>
                </div>
                <div class="prompt-title-section"><h1>${promptItem.title}</h1></div>
                <div id="formatting-toolbar">
                    <button data-command="bold" title="Grassetto (B)"><i class="fa-solid fa-bold"></i></button>
                    <button data-command="italic" title="Corsivo (I)"><i class="fa-solid fa-italic"></i></button>
                    <button data-command="underline" title="Sottolineato (U)"><i class="fa-solid fa-underline"></i></button>
                    <button data-command="insertUnorderedList" title="Lista puntata"><i class="fa-solid fa-list-ul"></i></button>
                    <button data-command="fontSizeUp" title="Aumenta dimensione testo (+)"><i class="fa-solid fa-plus"></i></button>
                    <button data-command="fontSizeDown" title="Diminuisci dimensione testo (-)"><i class="fa-solid fa-minus"></i></button>
                    <button data-command="showLinkModal" id="btn-create-link" title="Aggiungi Link (@)"><i class="fa-solid fa-link"></i></button>
                    <button data-command="unlink" title="Rimuovi Link"><i class="fa-solid fa-link-slash"></i></button>
                    <button data-command="insertImage" id="btn-insert-image" title="Aggiungi Immagine (Carica)"><i class="fa-regular fa-image"></i></button>
                    <button id="color-btn" title="Colore Testo"><i class="fa-solid fa-palette"></i></button>
                    <input type="color" id="colorPicker" value="#FFFFFF">
                    <button id="btnSaveChanges" class="add-button">Salva</button>
                </div>
                <div class="prompt-description-container" contenteditable="false" id="detail-description">${promptItem.description || ""}</div>
            </div>`;
        attachDetailViewListeners(promptItem, sub, cat);
    }
    
    function renderSpecialView(type) {
        const titles = { favorites: "Preferiti", recents: "Recenti" };
        const colList = document.getElementById('col-special-list');
        colList.innerHTML = `<div class="column-header"><h3>${titles[type]}</h3></div><div class="column-content"></div>`;
        
        let items = [];
        if (type === 'favorites') {
            state.allData.forEach(cat => cat.subcategories?.forEach(sub => sub.prompts?.forEach(p => { 
                if (p.favorite) items.push({ ...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id }); 
            })));
             items.sort((a,b)=>a.title.localeCompare(b.title));
        } else {
            state.recents.forEach(r => {
                const cat = state.allData.find(c => c.id === r.catId);
                const sub = cat?.subcategories.find(s => s.id === r.subId);
                const p = sub?.prompts.find(p_item => p_item.id === r.promptId);
                if (p) items.push({ ...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id, accessTime: r.timestamp || 0 });
            });
            items.sort((a,b)=>b.accessTime - a.accessTime); 
        }
        
        const listContainer = colList.querySelector('.column-content');
        if (!items.length) { 
            listContainer.innerHTML = `<div class="initial-message">Nessun elemento in ${titles[type]}</div>`; 
            document.getElementById('col-special-detail').innerHTML = '<div class="initial-message">Nessun prompt da visualizzare</div>'; 
            state.activePromptId = null;
            state.activeSubcategoryId = null;
            state.activeCategoryId = null;
            return; 
        }

        const currentActiveItem = items.find(p => p.id === state.activePromptId);
        if (!currentActiveItem) {
            state.activePromptId = items[0].id;
            state.activeSubcategoryId = items[0].subId;
            state.activeCategoryId = items[0].catId;
        }

        items.forEach(p => {
            const item = document.createElement("div");
            item.className = `item-container ${p.id === state.activePromptId ? 'active' : ''}`;
            item.innerHTML = `<div class="item-name">${p.title}</div><div class="item-path">${p.catName} > ${p.subName}</div>`;
            item.onclick = () => {
                state.activeCategoryId = p.catId; 
                state.activeSubcategoryId = p.subId; 
                state.activePromptId = p.id;
                trackRecentPrompt(p.id, p.subId, p.catId);
                renderUI(); 
            };
            listContainer.appendChild(item);
        });
        
        renderDetailColumn();
    }
    
    function attachDetailViewListeners(promptItem, sub, cat) {
        const colId = (state.currentView === 'favorites' || state.currentView === 'recents') ? 'col-special-detail' : 'col-detail';
        const col = document.getElementById(colId);
        if (!col) return;

        const descriptionContainer = col.querySelector("#detail-description");
        if (!descriptionContainer) return;

        // 1. Abilita/Disabilita Modifica
        col.querySelector("#edit-prompt-btn").onclick = () => {
            const isEditing = descriptionContainer.contentEditable === 'true';
            descriptionContainer.contentEditable = isEditing ? 'false' : 'true';
            descriptionContainer.setAttribute('contenteditable', isEditing ? 'false' : 'true');

            col.querySelector("#formatting-toolbar").classList.toggle("show", !isEditing);
            col.querySelector("#btnSaveChanges").classList.toggle("show", !isEditing);
            if (!isEditing) {
                 descriptionContainer.focus();
            } else {
                 Toast.show("Modifica annullata. Ricorda di cliccare Salva.", 'info');
            }
        };

        // 2. SALVATAGGIO
        col.querySelector("#btnSaveChanges").onclick = async () => {
            const newData = JSON.parse(JSON.stringify(state.allData));
            const promptToUpdate = newData.find(c=>c.id===cat.id)?.subcategories.find(s=>s.id===sub.id)?.prompts.find(p_item=>p_item.id===promptItem.id);
            if(promptToUpdate) {
                promptToUpdate.description = descriptionContainer.innerHTML;
            }
            descriptionContainer.contentEditable = 'false'; 
            descriptionContainer.setAttribute('contenteditable', 'false');
            col.querySelector("#formatting-toolbar").classList.remove("show");
            col.querySelector("#btnSaveChanges").classList.remove("show");

            await updateStateAndSave(newData);
            Toast.show("Prompt salvato!", 'success');
        };

        // 3. Formattazione
        col.querySelectorAll("#formatting-toolbar button[data-command]").forEach(btn => {
            btn.onclick = e => { 
                e.preventDefault(); 
                const command = btn.dataset.command;

                if (command === 'showLinkModal') {
                    showLinkModal();
                } 
                else if (command === 'fontSizeUp') {
                    document.execCommand('fontSize', false, '7'); 
                } 
                else if (command === 'fontSizeDown') {
                    document.execCommand('fontSize', false, '1');
                }
                else if (command === 'insertImage') {
                    imageInput.click();
                }
                else {
                    document.execCommand(command, false, null); 
                }
                if (command !== 'showLinkModal') {
                    descriptionContainer.focus(); 
                }
            };
        });
        
        const colorPicker = col.querySelector("#colorPicker");
        col.querySelector("#color-btn").onclick = () => colorPicker.click();
        colorPicker.onchange = () => {
            document.execCommand('foreColor', false, colorPicker.value);
            descriptionContainer.focus();
        };

        // 4. Copia, Preferiti, Elimina
        col.querySelector("#copy-prompt-btn").onclick = () => {
            const textToCopy = descriptionContainer.innerText;
            const tempElement = document.createElement('textarea');
            tempElement.value = textToCopy;
            tempElement.style.position = 'fixed'; tempElement.style.top = '0'; tempElement.style.left = '0'; tempElement.style.opacity = '0';
            document.body.appendChild(tempElement); tempElement.focus(); tempElement.select();
            try {
                const successful = document.execCommand('copy');
                Toast.show(successful ? "Copiato!" : "Errore nella copia (permessi mancanti).", successful ? 'success' : 'error');
            } catch (err) { Toast.show("Errore nella copia (browser/permessi).", 'error'); } 
            finally { document.body.removeChild(tempElement); }
        };
        col.querySelector("#delete-prompt-btn").onclick = () => deletePrompt(promptItem.id, sub.id, cat.id);
        col.querySelector("#fav-prompt-btn").onclick = async () => {
             const newData = JSON.parse(JSON.stringify(state.allData));
             const promptToUpdate = newData.find(c=>c.id===cat.id)?.subcategories.find(s=>s.id===sub.id)?.prompts.find(p_item=>p_item.id===promptItem.id);
             let newActiveIds = {};
             if(promptToUpdate) {
                promptToUpdate.favorite = !promptToUpdate.favorite;
             }
             await updateStateAndSave(newData, { newActiveIds, saveHistory: false });
        };
        
        // 5. Gestione Drag and Drop & Incolla
        descriptionContainer.addEventListener('paste', handlePaste);
        descriptionContainer.addEventListener('dragover', e => { 
            if (descriptionContainer.contentEditable === 'true') {
                e.preventDefault(); 
                descriptionContainer.classList.add('drag-over'); 
            }
        });
        descriptionContainer.addEventListener('dragleave', () => { 
            descriptionContainer.classList.remove('drag-over'); 
        });
        descriptionContainer.addEventListener('drop', e => {
            if (descriptionContainer.contentEditable === 'true') {
                e.preventDefault();
                descriptionContainer.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    insertBase64Image(e.dataTransfer.files[0]);
                }
            }
        });
        
        // 6. FIX: I link ora si aprono normalmente in una nuova scheda
        // Rimosso l'event listener che copiava l'URL negli appunti
        // I link con target="_blank" si apriranno automaticamente
    }
    
    function trackRecentPrompt(promptId, subId, catId) {
        const timestamp = Date.now();
        state.recents = state.recents.filter(r => r.promptId !== promptId);
        state.recents.unshift({ promptId, subId, catId, timestamp });
        if (state.recents.length > 20) state.recents.pop();
    }
    
    // --- DATA MANIPULATION ---
    async function addCategory() { 
        const name = window.prompt("Nome nuova categoria:"); 
        if (!name?.trim()) { Toast.show("Operazione annullata.", 'info'); return; } 
        const newCategory = { id: `cat_${Date.now()}`, name: name.trim(), subcategories: [] }; 
        const newData = [...state.allData, newCategory]; 
        await updateStateAndSave(newData, { newActiveIds: { currentView: 'columns', activeCategoryId: newCategory.id, activeSubcategoryId: null, activePromptId: null } }); 
        Toast.show(`Categoria "${newCategory.name}" aggiunta!`, 'success');
    }
    
    async function addSubcategory(categoryId) { 
        const name = window.prompt("Nome nuova sottocategoria:"); 
        if (!name?.trim()) { Toast.show("Operazione annullata.", 'info'); return; } 
        const newData = JSON.parse(JSON.stringify(state.allData)); 
        const cat = newData.find(c => c.id === categoryId); 
        if (!cat) {
            Toast.show("Errore: categoria non trovata.", 'error');
            return;
        }
        const newSub = { id: `sub_${Date.now()}`, name: name.trim(), prompts: [] }; 
        cat.subcategories.push(newSub); 
        await updateStateAndSave(newData, { newActiveIds: { activeSubcategoryId: newSub.id, activePromptId: null } }); 
        Toast.show(`Sottocategoria "${newSub.name}" aggiunta!`, 'success');
    }
    
    async function addNewPrompt(subcategoryId, categoryId) { 
        const title = window.prompt("Titolo nuovo prompt:"); 
        if (!title?.trim()) { Toast.show("Operazione annullata.", 'info'); return; } 
        
        const newData = JSON.parse(JSON.stringify(state.allData)); 
        const cat = newData.find(c => c.id === categoryId);
        if (!cat) {
            Toast.show("Errore: categoria non trovata.", 'error');
            return;
        }
        const sub = cat.subcategories.find(s => s.id === subcategoryId);
        if (!sub) {
            Toast.show("Errore: sottocategoria non trovata.", 'error');
            return;
        }
        
        const newPrompt = { id: `p_${Date.now()}`, title: title.trim(), description: "Aggiungi una descrizione...", favorite: false }; 
        sub.prompts.push(newPrompt); 
        await updateStateAndSave(newData, { newActiveIds: { activePromptId: newPrompt.id } }); 
        Toast.show(`Prompt "${newPrompt.title}" aggiunto!`, 'success');
    }
    
    async function deletePrompt(promptId, subId, catId) { 
        if (!window.confirm("Sei sicuro di voler eliminare questo prompt?")) return; 
        const newData = JSON.parse(JSON.stringify(state.allData)); 
        const sub = newData.find(c=>c.id===catId)?.subcategories.find(s=>s.id===subId); 
        if (!sub) return;
        const promptIndex = sub.prompts.findIndex(p_item => p_item.id === promptId); 
        if (promptIndex === -1) return;
        sub.prompts.splice(promptIndex, 1); 
        state.recents = state.recents.filter(r => r.promptId !== promptId);
        const newActivePromptId = sub.prompts[promptIndex]?.id || sub.prompts[promptIndex-1]?.id || sub.prompts[0]?.id || null; 
        let newActiveIds = { activePromptId: newActivePromptId };
        if (!newActivePromptId && (state.currentView === 'favorites' || state.currentView === 'recents')) { newActiveIds = { activePromptId: null, activeSubcategoryId: null, activeCategoryId: null }; }
        await updateStateAndSave(newData, { newActiveIds }); 
        Toast.show("Prompt eliminato!", 'info');
    }

    // --- TOOL FUNCTIONS ---
    function updateUndoRedoButtons() { document.getElementById('btnAnnulla').disabled = state.history.length === 0; document.getElementById('btnRipristina').disabled = state.redoStack.length === 0; }
    async function performUndo() { 
        if (state.history.length === 0) return; 
        const lastState = state.history.pop(); 
        state.redoStack.push(JSON.parse(JSON.stringify({ allData: state.allData, recents: state.recents, activeCategoryId: state.activeCategoryId, activeSubcategoryId: state.activeSubcategoryId, activePromptId: state.activePromptId, currentView: state.currentView }))); 
        Object.assign(state, lastState); 
        await Database.save(state.allData); 
        localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents)); 
        renderUI(); 
        Toast.show("Annullato!", 'info', 1500);
    }
    async function performRedo() { 
        if (state.redoStack.length === 0) return; 
        const nextState = state.redoStack.pop(); 
        state.history.push(JSON.parse(JSON.stringify({ allData: state.allData, recents: state.recents, activeCategoryId: state.activeCategoryId, activeSubcategoryId: state.activeSubcategoryId, activePromptId: state.activePromptId, currentView: state.currentView }))); 
        Object.assign(state, nextState); 
        await Database.save(state.allData); 
        localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents)); 
        renderUI(); 
        Toast.show("Ripristinato!", 'info', 1500);
    }
    function backupData() { 
        if(state.allData.length === 0) { Toast.show("Nessun dato da esportare.", "error"); return; } 
        const dataStr = JSON.stringify(state.allData, null, 2); 
        const blob = new Blob([dataStr], { type: "application/json" }); 
        const url = URL.createObjectURL(blob); 
        const a = document.createElement("a"); a.href = url; a.download = `prompts_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); 
        Toast.show("Backup scaricato!", 'success'); 
    }
    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async e => {
            try {
                const data = JSON.parse(e.target.result); 
                if (!Array.isArray(data)) throw new Error("Invalid format");
                const newCatId = data[0]?.id || null;
                const newSubId = data[0]?.subcategories?.[0]?.id || null;
                const newPromptId = data[0]?.subcategories?.[0]?.prompts?.[0]?.id || null;
                await updateStateAndSave(data, { newActiveIds: { currentView: 'columns', activeCategoryId: newCatId, activeSubcategoryId: newSubId, activePromptId: newPromptId }, saveHistory: false });
                state.history = []; state.redoStack = [];
                Toast.show("Importazione riuscita!", 'success');
            } catch (err) { Toast.show("File di backup non valido.", 'error'); }
        };
        reader.readAsText(file); event.target.value = '';
    }
    
    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.getElementById('themeToggle').addEventListener('click', () => { 
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light'; 
            document.documentElement.setAttribute('data-theme', newTheme); 
            localStorage.setItem('theme', newTheme); 
            document.getElementById('themeToggle').innerHTML = newTheme === 'dark' ? '<i class="fa-solid fa-moon"></i>' : '<i class="fa-solid fa-sun"></i>';
        });
        document.getElementById('themeToggle').innerHTML = document.documentElement.getAttribute('data-theme') === 'dark' ? '<i class="fa-solid fa-moon"></i>' : '<i class="fa-solid fa-sun"></i>';
        
        categoryDropdown.addEventListener('change', () => {
            const selection = categoryDropdown.value;
            if (selection === 'favorites' || selection === 'recents') {
                state.currentView = selection;
                state.activePromptId = null; state.activeSubcategoryId = null; state.activeCategoryId = null;
            } else if (selection === 'separator' || !selection) {
                return; 
            } else {
                state.currentView = 'columns';
                const newCat = state.allData.find(c => c.id === selection);
                state.activeCategoryId = selection;
                state.activeSubcategoryId = newCat?.subcategories.sort((a,b)=>a.name.localeCompare(b.name))[0]?.id || null;
                const firstSub = newCat?.subcategories.sort((a,b)=>a.name.localeCompare(b.name))[0];
                state.activePromptId = firstSub?.prompts?.sort((a,b)=>a.title.localeCompare(b.title))[0]?.id || null;
            }
            renderUI();
        });
        
        imageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                insertBase64Image(e.target.files[0]);
            }
            e.target.value = ''; 
        });

        const toolBtn = document.getElementById('toolBtn'); const toolMenu = document.getElementById('toolMenu');
        toolBtn.addEventListener('click', e => { e.stopPropagation(); toolMenu.classList.toggle('show'); });
        window.addEventListener('click', () => toolMenu.classList.remove('show'));
        document.getElementById('btnAddCategory').onclick = addCategory;
        document.getElementById('btnAnnulla').onclick = performUndo;
        document.getElementById('btnRipristina').onclick = performRedo;
        document.getElementById('btnBackup').onclick = backupData;
        document.getElementById('btnImporta').onclick = () => document.getElementById('backupInput').click();
        document.getElementById('backupInput').onchange = importData;

        linkModalCancel.onclick = hideLinkModal;
        linkModalConfirm.onclick = () => applyLink(linkUrlInput.value.trim());
        linkModal.addEventListener('click', (e) => { 
            if (e.target === linkModal) { 
                hideLinkModal(); 
            } 
        });
        linkUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyLink(linkUrlInput.value.trim());
            }
        });
    }

    // --- INITIALIZATION ---
    async function initialize() {
        Loader.show();
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
        await Database.init();
        state.allData = await Database.load();
        
        try { state.recents = JSON.parse(localStorage.getItem('promptManagerRecents')) || []; } catch (e) { state.recents = []; }

        if (state.allData.length === 0) {
            state.allData = [ 
                {
                    id: `cat_1`, 
                    name: 'AI Generative', 
                    subcategories: [ 
                        {
                            id: `sub_1`, 
                            name: 'Testi e Storie', 
                            prompts: [ 
                                {id: `p_1`, title: 'Prompt di Benvenuto', description: 'Benvenuto! Clicca l\'icona a forma di matita per modificare questo prompt. <strong>Clicca sul link arancione qui sotto per aprirlo in una nuova scheda:</strong> <a href="https://www.google.it/search?q=Prompt+Engineering" target="_blank">Link di Esempio Google</a>', favorite: true},
                                {id: `p_2`, title: 'Genera Articolo SEO', description: 'Scrivi un articolo di 1500 parole sul tema X, con 3 titoli e bullet points.', favorite: false} 
                            ]
                        },
                         {
                            id: `sub_2`, 
                            name: 'Immagini e DALL-E', 
                            prompts: [ 
                                {id: `p_3`, title: 'Stile Cinematografico', description: 'Crea una scena in stile cinematografico 4K, dettagliato, con luce drammatica.', favorite: true} 
                            ]
                        }
                    ]
                } 
            ];
            await Database.save(state.allData);
        }
        
        const firstCategory = state.allData[0];
        const firstSubcategory = firstCategory?.subcategories.sort((a,b)=>a.name.localeCompare(b.name))[0];
        const firstPrompt = firstSubcategory?.prompts.sort((a,b)=>a.title.localeCompare(b.title))[0];

        state.activeCategoryId = firstCategory?.id || null;
        state.activeSubcategoryId = firstSubcategory?.id || null;
        state.activePromptId = firstPrompt?.id || null;
        
        setupEventListeners();
        renderUI();
        Loader.hide();
    }
    
    initialize();
})();
</script>
</body>
</html>
