<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Manager v16 - Definitivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --background-dark: #121417; --container-bg: #22252A; --header-bg: #2D2F3E;
            --element-bg: #3A3D4D; --element-bg-hover: #4a4e5a; --primary-accent: #007BFF;
            --primary-accent-dark: #0056b3; --text-primary: #FFFFFF; --text-secondary: #E0E0E0;
            --text-muted: #9E9E9E; --border-color: #3A3D4D; --star-yellow: #FFC107;
            --btn-green: #28a745; --btn-red: #dc3545;
        }
        [data-theme="light"] {
            --background-dark: #F5F5F5; --container-bg: #FFFFFF; --header-bg: #E3E6F0;
            --element-bg: #F8F9FA; --element-bg-hover: #E9ECEF; --primary-accent: #0066CC;
            --text-primary: #212529; --text-secondary: #495057; --border-color: #DEE2E6;
            --star-yellow: #FFC107; 
        }
        * { box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--background-dark); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; color: var(--text-primary); display: flex; flex-direction: column; }
        .app-header { background-color: var(--header-bg); border-radius: 16px; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,.2); margin-bottom: 20px; flex-shrink: 0; }
        .header-left, .header-center, .header-right { display: flex; align-items: center; gap: 16px; }
        .logo { color: var(--text-primary); font-size: 28px; font-weight: bold; }
        .search-bar { display: flex; align-items: center; background-color: var(--element-bg); border-radius: 12px; padding: 0 15px; }
        .search-bar input { background: transparent; border: none; outline: none; color: var(--text-primary); padding: 12px 10px; font-size: 16px; width: 280px; }
        .category-dropdown-container { display: flex; align-items: center; background-color: var(--element-bg); border-radius: 12px; padding: 0 15px; }
        #category-dropdown { background: transparent; border: none; outline: none; color: var(--text-primary); padding: 12px 0; font-size: 16px; width: 220px; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; }
        #category-dropdown option { background-color: var(--container-bg); color: var(--text-primary); }
        .tool-button { background-color: #7A69E9; color: #FFFFFF; border: none; border-radius: 12px; padding: 10px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .theme-toggle { background-color: var(--element-bg); color: var(--text-primary); border: none; border-radius: 12px; padding: 10px 16px; font-size: 18px; cursor: pointer; }
        .header-right { position: relative; }
        .toolbar-dropdown-menu { display: none; position: absolute; top: 110%; right: 0; background-color: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; z-index: 1000; width: 360px; box-shadow: 0 8px 16px rgba(0,0,0,.4); grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .toolbar-dropdown-menu.show { display: grid; }
        .toolbar-btn { color: white; border: none; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; text-align: center; min-height: 70px; }
        .toolbar-btn:disabled { background-color: #555 !important; cursor: not-allowed; opacity: .5; }
        .btn-green { background-color: var(--btn-green); } .btn-yellow { background-color: #f7b731; color: #333; } .btn-blue { background-color: #007bff; } .btn-dark-blue { background-color: #0d47a1; } .btn-red { background-color: var(--btn-red); }
        
        main { display: grid; gap: 20px; flex-grow: 1; min-height: 0; }
        main.view-mode-three-column { grid-template-columns: 320px 320px 1fr; }
        main.view-mode-two-column { grid-template-columns: 400px 1fr; }

        .column { background-color: var(--container-bg); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--element-bg); padding-bottom: 10px; flex-shrink: 0; }
        .column-header-title { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .column-header h3 { margin: 0; font-size: 18px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .column-header-title .rename-icon { color: var(--text-muted); cursor: pointer; font-size: 15px; }
        .column-header-title .rename-icon:hover { color: var(--primary-accent); }
        .column-content { overflow-y: auto; padding-right: 10px; margin-right: -10px; }
        .column-content::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-thumb { background-color: var(--element-bg); border-radius: 20px; }
        .add-button { background-color: var(--btn-green); color: white; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; }
        .item-container { display: flex; flex-direction: column; align-items: flex-start; padding: 12px; background-color: var(--element-bg); border-radius: 6px; margin-bottom: 8px; color: var(--text-secondary); border-left: 3px solid transparent; cursor: pointer; }
        .item-container:hover { background-color: var(--element-bg-hover); }
        .item-container.active { background-color: var(--primary-accent-dark); border-left-color: var(--star-yellow); color: white; }
        .item-name { font-weight: 500; margin-bottom: 4px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-path { font-size: 12px; color: var(--text-muted); }
        .item-container.active .item-path { color: #ddd; }
        
        .tag-badge { 
            display: inline-block; padding: 3px 8px; border-radius: 12px; 
            font-size: 11px; font-weight: 600; margin: 2px 4px 2px 0; 
            color: white; white-space: nowrap;
        }
        .tags-container { 
            display: flex; flex-wrap: wrap; margin-top: 6px; gap: 4px;
        }
        .tag-input-section {
            padding: 15px 20px; border-bottom: 1px solid var(--border-color);
            background-color: var(--element-bg);
        }
        .tag-input-wrapper { display: flex; gap: 10px; align-items: center; }
        .tag-input-wrapper input {
            flex: 1; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; background-color: var(--container-bg);
            color: var(--text-primary); font-size: 14px;
        }
        .tag-input-wrapper button {
            padding: 10px 20px; background-color: var(--primary-accent);
            color: white; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        .tag-input-wrapper button:hover { background-color: var(--primary-accent-dark); }
        .current-tags { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-badge-removable {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 16px; font-size: 13px;
            font-weight: 600; color: white; cursor: pointer;
        }
        .tag-badge-removable i { font-size: 10px; opacity: 0.8; }
        .tag-badge-removable:hover { opacity: 0.8; }
        
        #col-detail, #col-special-detail { padding: 0; }
        .prompt-detail-view { height: 100%; display: flex; flex-direction: column; }
        .prompt-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0;}
        .prompt-actions-toolbar { display: flex; gap: 15px; }
        .prompt-actions-toolbar i { cursor: pointer; font-size: 18px; }
        .prompt-actions-toolbar .fa-star.fa-solid { color: var(--star-yellow); }
        .prompt-title-section { display: flex; align-items: center; gap: 15px; padding: 15px 20px; }
        .prompt-title-section h1 { margin: 0; font-size: 24px; color: var(--text-primary); }
        .prompt-title-section .rename-icon { color: var(--text-muted); cursor: pointer; font-size: 20px; }
        .prompt-title-section .rename-icon:hover { color: var(--primary-accent); }

        #formatting-toolbar { padding: 10px 20px; display: none; gap: 8px; align-items: center; flex-wrap: wrap; background-color: var(--element-bg); border-bottom: 1px solid var(--border-color); }
        #formatting-toolbar.show { display: flex; }
        #formatting-toolbar button { 
            background: var(--element-bg-hover); border: none; color: var(--text-primary); 
            padding: 8px 12px; border-radius: 5px; cursor: pointer; 
            font-size: 16px; display: flex; align-items: center; justify-content: center;
        }
        #formatting-toolbar button:hover { background: var(--primary-accent-dark); }
        #btnSaveChanges { background-color: var(--primary-accent); display: none; margin-left: auto; color: #FFFFFF; }
        #btnSaveChanges.show { display: inline-block; }
        .prompt-description-container { padding: 20px; line-height: 1.7; flex-grow: 1; overflow-y: auto; min-height: 0; }
        .prompt-description-container:focus { outline: none; }
        .prompt-description-container[contenteditable="true"] { outline: 2px dashed var(--primary-accent); }
        .initial-message { text-align: center; color: var(--text-muted); font-size: 16px; padding: 20px; height: 100%; display: flex; align-items: center; justify-content: center; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--container-bg); border-left: 4px solid var(--primary-accent); padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.3); }
        .toast.error { border-left-color: var(--btn-red); } .toast.success { border-left-color: var(--btn-green); }
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .loading-spinner i { font-size: 48px; color: var(--primary-accent); animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .prompt-description-container[contenteditable="true"].drag-over {
            outline: 3px dashed var(--star-yellow);
            background-color: rgba(255, 193, 7, 0.1);
        }
        .prompt-description-container a { color: #FFA500; text-decoration: underline; cursor: pointer; }
        .prompt-description-container a:hover { color: #FF8C00; text-decoration: underline; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center; align-items: center;
            z-index: 10001;
        }
        .modal-content {
            background-color: var(--container-bg); border-radius: 12px;
            padding: 30px; width: 90%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .modal-content h4 {
            margin-top: 0; color: var(--text-primary);
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
            font-size: 1.25rem;
        }
        .modal-content input[type="text"] {
            width: 100%; padding: 12px; margin: 15px 0 25px 0;
            border: 1px solid var(--border-color); border-radius: 8px;
            background-color: var(--element-bg); color: var(--text-primary);
            font-size: 16px; outline: none;
        }
        .modal-content input[type="text"]:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .modal-btn.cancel { background-color: var(--element-bg-hover); color: var(--text-secondary); }
        .modal-btn.confirm { background-color: var(--primary-accent); color: white; }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay"><div class="loading-spinner"><i class="fa-solid fa-spinner"></i></div></div>

<div class="modal-overlay" id="linkModal">
    <div class="modal-content">
        <h4>Inserisci l'URL del Link</h4>
        <input type="text" id="linkUrlInput" placeholder="Es: https://www.google.it" value="">
        <div class="modal-actions">
            <button class="modal-btn cancel" id="linkModalCancel">Annulla</button>
            <button class="modal-btn confirm" id="linkModalConfirm">Conferma</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="renameModal">
    <div class="modal-content">
        <h4 id="renameModalTitle">Rinomina Elemento</h4>
        <input type="text" id="renameInput" placeholder="Inserisci il nuovo nome...">
        <div class="modal-actions">
            <button class="modal-btn cancel" id="renameModalCancel">Annulla</button>
            <button class="modal-btn confirm" id="renameModalConfirm">Conferma</button>
        </div>
    </div>
</div>

<header class="app-header">
    <div class="header-left"><div class="logo">PS</div></div>
    <div class="header-center">
        <div class="search-bar">
             <i class="fa-solid fa-magnifying-glass"></i>
             <input type="text" id="search-input" placeholder="Cerca...">
        </div>
        <div class="category-dropdown-container">
            <i class="fa-solid fa-list"></i>
            <select id="category-dropdown" title="Seleziona una categoria"></select>
        </div>
    </div>
    <div class="header-right">
        <button class="theme-toggle" id="themeToggle" title="Cambia tema"><i class="fa-solid fa-moon"></i></button>
        <button class="tool-button" id="toolBtn"><i class="fa-solid fa-screwdriver-wrench"></i><span>Tool</span></button>
        <div class="toolbar-dropdown-menu" id="toolMenu">
            <button class="toolbar-btn btn-green" id="btnAddCategory"><i class="fa-solid fa-plus"></i><span>Aggiungi Categoria</span></button>
            <button class="toolbar-btn btn-yellow" id="btnAnnulla"><i class="fa-solid fa-arrow-rotate-left"></i><span>Annulla</span></button>
            <button class="toolbar-btn btn-yellow" id="btnRipristina"><i class="fa-solid fa-arrow-rotate-right"></i><span>Ripristina</span></button>
            <button class="toolbar-btn btn-blue" id="btnBackup"><i class="fa-solid fa-download"></i><span>Backup</span></button>
            <button class="toolbar-btn btn-dark-blue" id="btnImporta"><i class="fa-solid fa-upload"></i><span>Importa</span></button>
        </div>
    </div>
</header>
<input type="file" id="backupInput" style="display:none" accept=".json">
<input type="file" id="imageInput" style="display:none" accept="image/*">

<main id="main-content-area"></main>

<script>
(async () => {
    // --- SYSTEMS ---
    const Loader = { el: document.getElementById('loading-overlay'), show() { this.el.style.display = 'flex'; }, hide() { this.el.style.display = 'none'; } };
    const Toast = { container: document.getElementById('toast-container'), show(message, type = 'info', duration = 3000) { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; this.container.appendChild(t); setTimeout(() => t.remove(), duration); } };
    const Database = { DB_NAME: "PromptManagerDB_v16", STORE_NAME: "promptsData", db: null, async init() { return new Promise((resolve, reject) => { const r=indexedDB.open(this.DB_NAME, 1); r.onerror=reject; r.onsuccess=e=>{this.db=e.target.result;resolve();}; r.onupgradeneeded=e=>e.target.result.createObjectStore(this.STORE_NAME, {keyPath:"id"}); }); }, async save(data) { return new Promise((resolve, reject) => { const tx=this.db.transaction([this.STORE_NAME],"readwrite"); tx.objectStore(this.STORE_NAME).put({id:"main",data}); tx.oncomplete=resolve; tx.onerror=reject; }); }, async load() { return new Promise((resolve, reject) => { const r=this.db.transaction([this.STORE_NAME]).objectStore(this.STORE_NAME).get("main"); r.onsuccess=e=>resolve(e.target.result?e.target.result.data:[]); r.onerror=reject; }); } };
    
    // --- UTILITIES ---
    function updateColorPickerValue() {
        const colorPicker = document.getElementById('colorPicker');
        if (!colorPicker) return;
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        colorPicker.value = (currentTheme === 'dark') ? '#FFFFFF' : '#212529';
    }

    function getTagColor(tagName) {
        let hash = 0;
        for (let i = 0; i < tagName.length; i++) { hash = tagName.charCodeAt(i) + ((hash << 5) - hash); }
        const hue = hash % 360;
        return `hsl(${hue}, 65%, 50%)`;
    }
    
    function handlePaste(event) {
        event.preventDefault();
        event.stopPropagation();
        let text = (event.clipboardData || window.clipboardData)?.getData('text/plain') || '';
        if (text) document.execCommand('insertText', false, text);
    }
    
    // --- STATE ---
    let state = { allData: [], history: [], redoStack: [], recents: [], currentView: 'favorites', activeCategoryId: null, activeSubcategoryId: null, activePromptId: null, activeTag: null, startEditingNewPrompt: false };
    let savedRange = null;
    let itemToRename = null;
    
    // --- DOM ELEMENTS ---
    const mainArea = document.getElementById("main-content-area");
    const categoryDropdown = document.getElementById("category-dropdown");
    const imageInput = document.getElementById('imageInput');
    const linkModal = document.getElementById('linkModal');
    const linkUrlInput = document.getElementById('linkUrlInput');
    const renameModal = document.getElementById('renameModal');
    const renameInput = document.getElementById('renameInput');

    // --- MODAL & UI FUNCTIONS ---
    function showLinkModal() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && selection.toString().length > 0) { savedRange = selection.getRangeAt(0); } 
        else { Toast.show("Seleziona il testo da trasformare in link.", 'error'); return; }
        linkUrlInput.value = '';
        linkModal.style.display = 'flex';
        setTimeout(() => linkUrlInput.focus(), 50);
    }

    function hideLinkModal() { linkModal.style.display = 'none'; savedRange = null; }
    
    function applyLink(url) {
        if (!url || url.trim().length < 5) { Toast.show("URL non valido.", 'error'); return; }
        let finalUrl = url.trim();
        if (!finalUrl.match(/^[a-zA-Z]+:\/\//)) { finalUrl = 'https://' + finalUrl; }
        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);
            document.execCommand('insertHTML', false, `<a href="${finalUrl}" target="_blank">${savedRange.toString()}</a>`);
            document.querySelector('.prompt-description-container[contenteditable="true"]')?.focus();
            hideLinkModal();
        }
    }

    function showRenameModal(type, id, currentName, extraIds = {}) {
        itemToRename = { type, id, ...extraIds };
        const titles = { category: 'Rinomina Categoria', subcategory: 'Rinomina Sottocategoria', prompt: 'Rinomina Prompt' };
        renameModal.querySelector('h4').textContent = titles[type] || 'Rinomina Elemento';
        renameInput.value = currentName;
        renameModal.style.display = 'flex';
        setTimeout(() => renameInput.focus(), 50);
    }

    function hideRenameModal() { renameModal.style.display = 'none'; itemToRename = null; }

    async function handleRenameConfirm() {
        if (!itemToRename) return;
        const newName = renameInput.value.trim();
        if (!newName) { Toast.show("Il nome non può essere vuoto.", 'error'); return; }
        const { type, id, categoryId } = itemToRename;
        const newData = JSON.parse(JSON.stringify(state.allData));
        let success = false, item;
        if (type === 'category' && (item = newData.find(c => c.id === id))) { item.name = newName; success = true; } 
        else if (type === 'subcategory' && (item = newData.find(c => c.id === categoryId)?.subcategories.find(s => s.id === id))) { item.name = newName; success = true; }
        else if (type === 'prompt' && (item = newData.find(c => c.id === state.activeCategoryId)?.subcategories.find(s => s.id === state.activeSubcategoryId)?.prompts.find(p => p.id === id))) { item.title = newName; success = true; }
        if (success) {
            hideRenameModal();
            await updateStateAndSave(newData);
            Toast.show("Elemento rinominato!", 'success');
        } else { Toast.show("Errore: elemento non trovato.", 'error'); }
    }

    function insertBase64Image(file) {
        if (!file.type.startsWith('image/')) { Toast.show("Il file non è un'immagine.", 'error'); return; }
        if (file.size > 2 * 1024 * 1024) { Toast.show("Immagine troppo grande (Max 2MB).", 'error'); return; }
        const reader = new FileReader();
        reader.onload = e => {
            const descriptionContainer = document.querySelector('.prompt-description-container[contenteditable="true"]');
            if (!descriptionContainer) return;
            document.execCommand('insertHTML', false, `<img src="${e.target.result}" style="max-width: 100%;" alt="Immagine">`);
            descriptionContainer.focus();
        };
        reader.readAsDataURL(file);
    }

    // --- CORE LOGIC ---
    async function updateStateAndSave(newData, { newActiveIds = {}, saveHistory = true } = {}) {
        Loader.show();
        if (saveHistory) { state.redoStack = []; state.history.push(JSON.parse(JSON.stringify({ ...state }))); if (state.history.length > 30) state.history.shift(); }
        state.allData = newData;
        Object.assign(state, newActiveIds);
        await Database.save(state.allData);
        localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents));
        renderUI();
        Loader.hide();
    }
    
    // --- RENDER FUNCTIONS ---
    function renderUI() {
        renderCategoryDropdown();
        switch(state.currentView) {
            case 'favorites': case 'recents': case 'tags':
                mainArea.className = 'view-mode-two-column'; 
                mainArea.innerHTML = `<div id="col-special-list" class="column"></div> <div id="col-special-detail" class="column"></div>`; 
                if (state.currentView === 'tags') renderTagsView();
                else renderSpecialView(state.currentView);
                break;
            default: 
                mainArea.className = 'view-mode-three-column'; 
                renderColumnsView(); 
                break;
        }
        updateUndoRedoButtons();
    }

    function renderColumnsView() {
        mainArea.innerHTML = `<div id="col-subcategories" class="column"></div> <div id="col-prompts" class="column"></div> <div id="col-detail" class="column"></div>`;
        renderSubcategoryColumn();
        renderPromptColumn();
        renderDetailColumn();
    }
    
    function renderCategoryDropdown() {
        categoryDropdown.innerHTML = "";
        const createOption = (value, text) => { const opt = document.createElement('option'); opt.value = value; opt.textContent = text; return opt; };
        [['favorites', '⭐ Preferiti'], ['recents', '🕒 Recenti'], ['tags', '🏷️ Tag']].forEach(([val, txt]) => categoryDropdown.appendChild(createOption(val, txt)));
        if (state.allData.length > 0) {
            const separator = createOption('separator', '──────────'); separator.disabled = true; categoryDropdown.appendChild(separator);
            state.allData.sort((a,b)=>a.name.localeCompare(b.name)).forEach(category => categoryDropdown.appendChild(createOption(category.id, category.name)));
        }
        categoryDropdown.value = ['favorites', 'recents', 'tags'].includes(state.currentView) ? state.currentView : state.activeCategoryId || (state.allData[0]?.id || 'favorites');
    }
    
    function renderSubcategoryColumn() {
        const col = document.getElementById('col-subcategories');
        const activeCategory = state.allData.find(c => c.id === state.activeCategoryId);
        if (!activeCategory) { col.innerHTML = '<div class="initial-message">Seleziona una categoria</div>'; return; }
        col.innerHTML = `
            <div class="column-header">
                <div class="column-header-title">
                    <h3>${activeCategory.name}</h3>
                    <i class="fa-solid fa-pen-to-square rename-icon" id="rename-cat-btn" title="Rinomina"></i>
                </div>
                <button class="add-button" id="add-subcat-btn"><i class="fa-solid fa-plus"></i> Sottocategoria</button>
            </div>
            <div class="column-content"></div>`;
        document.getElementById('add-subcat-btn').onclick = () => addSubcategory(activeCategory.id);
        document.getElementById('rename-cat-btn').onclick = () => showRenameModal('category', activeCategory.id, activeCategory.name);
        const listContainer = col.querySelector('.column-content');
        if (!activeCategory.subcategories?.length) { listContainer.innerHTML = '<div class="initial-message">Nessuna sottocategoria</div>'; return; }
        activeCategory.subcategories.sort((a,b)=>a.name.localeCompare(b.name)).forEach(sub => { 
            const item = document.createElement("div"); 
            item.className = `item-container ${sub.id===state.activeSubcategoryId?'active':''}`; 
            item.innerHTML = `<span class="item-name">${sub.name}</span>`; 
            item.onclick = () => { Object.assign(state, { currentView: 'columns', activeSubcategoryId: sub.id, activePromptId: sub.prompts?.sort((a,b)=>a.title.localeCompare(b.title))[0]?.id || null }); renderUI(); }; 
            listContainer.appendChild(item); 
        });
    }

    function renderPromptColumn() {
        const col = document.getElementById('col-prompts');
        const activeSub = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId);
        if (!activeSub) { col.innerHTML = '<div class="initial-message">Seleziona una sottocategoria</div>'; return; }
        col.innerHTML = `
            <div class="column-header">
                 <div class="column-header-title">
                    <h3>${activeSub.name}</h3>
                    <i class="fa-solid fa-pen-to-square rename-icon" id="rename-subcat-btn" title="Rinomina"></i>
                </div>
                <button class="add-button" id="add-prompt-btn"><i class="fa-solid fa-plus"></i> Prompt</button>
            </div>
            <div class="column-content"></div>`;
        document.getElementById('rename-subcat-btn').onclick = () => showRenameModal('subcategory', activeSub.id, activeSub.name, { categoryId: state.activeCategoryId });
        document.getElementById('add-prompt-btn').onclick = () => addNewPrompt(activeSub.id, state.activeCategoryId);
        const listContainer = col.querySelector('.column-content');
        if (!activeSub.prompts?.length) { listContainer.innerHTML = '<div class="initial-message">Nessun prompt</div>'; return; }
        activeSub.prompts.sort((a,b)=>a.title.localeCompare(b.title)).forEach(p => { 
            const item = document.createElement("div"); 
            item.className = `item-container ${p.id===state.activePromptId?'active':''}`; 
            const tagsHtml = p.tags?.map(tag => `<span class="tag-badge" style="background-color: ${getTagColor(tag)}">${tag}</span>`).join('') || '';
            item.innerHTML = `<div class="item-name">${p.title}</div>${tagsHtml ? `<div class="tags-container">${tagsHtml}</div>` : ''}`; 
            item.onclick = () => { state.activePromptId = p.id; trackRecentPrompt(p.id, activeSub.id, state.activeCategoryId); renderUI(); }; 
            listContainer.appendChild(item); 
        });
    }

    function renderDetailColumn() {
        const colId = ['favorites', 'recents', 'tags'].includes(state.currentView) ? 'col-special-detail' : 'col-detail';
        const col = document.getElementById(colId);
        if (!col) return;
        const promptItem = state.allData.find(c => c.id === state.activeCategoryId)?.subcategories.find(s => s.id === state.activeSubcategoryId)?.prompts.find(p => p.id === state.activePromptId);
        if (!promptItem) { col.innerHTML = '<div class="initial-message">Seleziona un prompt</div>'; return; }
        
        col.innerHTML = `
            <div class="prompt-detail-view">
                <div class="prompt-header"><h3>Dettagli Prompt</h3>
                    <div class="prompt-actions-toolbar">
                        <i id="edit-prompt-btn" class="fa-solid fa-pencil" title="Modifica"></i>
                        <i id="copy-prompt-btn" class="fa-solid fa-copy" title="Copia"></i>
                        <i id="fav-prompt-btn" class="${promptItem.favorite ? "fa-solid" : "fa-regular"} fa-star" title="Preferito"></i>
                        <i id="delete-prompt-btn" class="fa-solid fa-trash-can" title="Elimina"></i>
                    </div>
                </div>
                <div class="prompt-title-section">
                    <h1>${promptItem.title}</h1>
                    <i class="fa-solid fa-pen-to-square rename-icon" id="rename-prompt-btn" title="Rinomina"></i>
                </div>
                <div class="tag-input-section">
                    <div class="tag-input-wrapper">
                        <input type="text" id="tag-input" placeholder="Aggiungi un tag...">
                        <button id="add-tag-btn"><i class="fa-solid fa-plus"></i> Aggiungi</button>
                    </div>
                    <div class="current-tags" id="current-tags-container"></div>
                </div>
                <div id="formatting-toolbar">
                    <button data-command="bold" title="Grassetto"><i class="fa-solid fa-bold"></i></button>
                    <button data-command="italic" title="Corsivo"><i class="fa-solid fa-italic"></i></button>
                    <button data-command="underline" title="Sottolineato"><i class="fa-solid fa-underline"></i></button>
                    <button data-command="insertUnorderedList" title="Lista"><i class="fa-solid fa-list-ul"></i></button>
                    <button data-command="showLinkModal" title="Link"><i class="fa-solid fa-link"></i></button>
                    <button data-command="unlink" title="Rimuovi Link"><i class="fa-solid fa-link-slash"></i></button>
                    <button data-command="removeFormat" title="Rimuovi Formato"><i class="fa-solid fa-eraser"></i></button>
                    <button data-command="insertImage" title="Immagine"><i class="fa-regular fa-image"></i></button>
                    <button id="color-btn" title="Colore"><i class="fa-solid fa-palette"></i></button>
                    <input type="color" id="colorPicker" style="visibility: hidden; width: 0; height: 0; padding: 0; border: none;">
                    <button id="btnSaveChanges" class="add-button">Salva</button>
                </div>
                <div class="prompt-description-container" contenteditable="false" id="detail-description">${promptItem.description || ""}</div>
            </div>`;
        
        attachDetailViewListeners(promptItem);
        renderCurrentTags(promptItem);

        if (state.startEditingNewPrompt) {
            document.getElementById('edit-prompt-btn')?.click();
            state.startEditingNewPrompt = false;
        }
    }
    
    function renderCurrentTags(promptItem) {
        const container = document.getElementById('current-tags-container');
        if (!container) return;
        container.innerHTML = (promptItem.tags || []).map(tag => 
            `<span class="tag-badge-removable" style="background-color: ${getTagColor(tag)}" data-tag-name="${tag}">
                ${tag} <i class="fa-solid fa-xmark"></i>
            </span>`
        ).join('');
        container.querySelectorAll('.tag-badge-removable').forEach(el => 
            el.onclick = () => removeTag(promptItem, el.dataset.tagName)
        );
    }
    
    async function addTag(promptItem, tagName) {
        const cleanTag = tagName?.trim().toLowerCase();
        if (!cleanTag) { Toast.show("Inserisci un nome per il tag.", 'error'); return; }
        const p = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId)?.prompts.find(pr=>pr.id===promptItem.id);
        if (!p) return;
        if (!p.tags) p.tags = [];
        if (p.tags.includes(cleanTag)) { Toast.show("Tag già presente.", 'info'); return; }
        p.tags.push(cleanTag);
        await updateStateAndSave(state.allData, { saveHistory: false });
    }
    
    async function removeTag(promptItem, tagName) {
        const p = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId)?.prompts.find(pr=>pr.id===promptItem.id);
        if (p?.tags) { p.tags = p.tags.filter(t => t !== tagName); await updateStateAndSave(state.allData, { saveHistory: false }); }
    }
    
    function renderTagsView() {
        const colList = document.getElementById('col-special-list');
        colList.innerHTML = `<div class="column-header"><h3>🏷️ Filtra per Tag</h3></div><div class="column-content"></div>`;
        const allTags = [...new Set(state.allData.flatMap(c => c.subcategories?.flatMap(s => s.prompts?.flatMap(p => p.tags || []) || []) || []))].sort();
        const listContainer = colList.querySelector('.column-content');
        if (allTags.length === 0) { listContainer.innerHTML = '<div class="initial-message">Nessun tag</div>'; document.getElementById('col-special-detail').innerHTML = ''; return; }
        if (!state.activeTag || !allTags.includes(state.activeTag)) { state.activeTag = allTags[0]; }
        listContainer.innerHTML = allTags.map(tag => `<div class="item-container ${tag === state.activeTag ? 'active' : ''}" data-tag-name="${tag}"><span class="tag-badge" style="background-color: ${getTagColor(tag)}">${tag}</span></div>`).join('');
        listContainer.querySelectorAll('.item-container').forEach(el => el.onclick = () => { state.activeTag = el.dataset.tagName; renderTagsView(); });
        renderPromptsForTag(state.activeTag);
    }
    
    function renderPromptsForTag(tagName) {
        const colDetail = document.getElementById('col-special-detail');
        colDetail.innerHTML = `<div class="column-header"><h3>Prompt con: <span class="tag-badge" style="background-color:${getTagColor(tagName)}">${tagName}</span></h3></div><div class="column-content"></div>`;
        const items = state.allData.flatMap(cat => cat.subcategories?.flatMap(sub => sub.prompts?.filter(p => p.tags?.includes(tagName)).map(p => ({...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id})) || []) || []).sort((a,b)=>a.title.localeCompare(b.title));
        const listContainer = colDetail.querySelector('.column-content');
        if (items.length === 0) { listContainer.innerHTML = '<div class="initial-message">Nessun prompt</div>'; return; }
        listContainer.innerHTML = items.map(p => `<div class="item-container" data-cat-id="${p.catId}" data-sub-id="${p.subId}" data-prompt-id="${p.id}"><div class="item-name">${p.title}</div><div class="item-path">${p.catName} > ${p.subName}</div></div>`).join('');
        listContainer.querySelectorAll('.item-container').forEach(el => el.onclick = () => { Object.assign(state, { currentView: 'tags', activeCategoryId: el.dataset.catId, activeSubcategoryId: el.dataset.subId, activePromptId: el.dataset.promptId }); trackRecentPrompt(state.activePromptId, state.activeSubcategoryId, state.activeCategoryId); renderUI(); });
    }
    
    function renderSpecialView(type) {
        const titles = { favorites: "⭐ Preferiti", recents: "🕒 Recenti" };
        const colList = document.getElementById('col-special-list');
        colList.innerHTML = `<div class="column-header"><h3>${titles[type]}</h3></div><div class="column-content"></div>`;
        let items = [];
        if (type === 'favorites') {
            items = state.allData.flatMap(cat => cat.subcategories?.flatMap(sub => sub.prompts?.filter(p => p.favorite).map(p => ({...p, catName: cat.name, subName: sub.name, catId: cat.id, subId: sub.id})) || []) || []).sort((a,b)=>a.title.localeCompare(b.title));
        } else {
            items = state.recents.map(r => {
                const p = state.allData.find(c=>c.id===r.catId)?.subcategories.find(s=>s.id===r.subId)?.prompts.find(pr=>pr.id===r.promptId);
                return p ? {...p, catName: state.allData.find(c=>c.id===r.catId).name, subName: state.allData.find(c=>c.id===r.catId).subcategories.find(s=>s.id===r.subId).name, catId: r.catId, subId: r.subId} : null;
            }).filter(Boolean);
        }
        const listContainer = colList.querySelector('.column-content');
        if (items.length === 0) { listContainer.innerHTML = `<div class="initial-message">Nessun elemento</div>`; document.getElementById('col-special-detail').innerHTML = ''; Object.assign(state, { activePromptId: null, activeSubcategoryId: null, activeCategoryId: null }); return; }
        if (!items.find(p => p.id === state.activePromptId)) Object.assign(state, { activePromptId: items[0].id, activeSubcategoryId: items[0].subId, activeCategoryId: items[0].catId });
        listContainer.innerHTML = items.map(p => `<div class="item-container ${p.id===state.activePromptId?'active':''}" data-cat-id="${p.catId}" data-sub-id="${p.subId}" data-prompt-id="${p.id}"><div class="item-name">${p.title}</div><div class="item-path">${p.catName} > ${p.subName}</div></div>`).join('');
        listContainer.querySelectorAll('.item-container').forEach(el => el.onclick = () => { Object.assign(state, { activeCategoryId: el.dataset.catId, activeSubcategoryId: el.dataset.subId, activePromptId: el.dataset.promptId }); trackRecentPrompt(state.activePromptId, state.activeSubcategoryId, state.activeCategoryId); renderUI(); });
        renderDetailColumn();
    }
    
    function attachDetailViewListeners(promptItem) {
        const descContainer = document.getElementById("detail-description");
        const toolbar = document.getElementById("formatting-toolbar");
        const saveBtn = document.getElementById("btnSaveChanges");
        const tagInput = document.getElementById('tag-input');
        
        document.getElementById('rename-prompt-btn').onclick = () => showRenameModal('prompt', promptItem.id, promptItem.title);
        document.getElementById('add-tag-btn').onclick = () => { addTag(promptItem, tagInput.value); tagInput.value = ''; };
        tagInput.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('add-tag-btn').click(); } };

        document.getElementById("edit-prompt-btn").onclick = () => {
            const isEditing = descContainer.contentEditable === 'true';
            // *** SOLUZIONE DEFINITIVA ***
            // Aggiorna il colore DEL SELETTORE nel momento esatto in cui si apre la toolbar.
            if (!isEditing) { updateColorPickerValue(); }
            descContainer.contentEditable = !isEditing;
            toolbar.classList.toggle("show", !isEditing);
            saveBtn.classList.toggle("show", !isEditing);
            if (!isEditing) descContainer.focus();
        };

        saveBtn.onclick = async () => {
            const p = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId)?.prompts.find(pr=>pr.id===promptItem.id);
            if (p) p.description = descContainer.innerHTML;
            descContainer.contentEditable = 'false'; 
            toolbar.classList.remove("show");
            saveBtn.classList.remove("show");
            await updateStateAndSave(state.allData);
            Toast.show("Prompt salvato!", 'success');
        };

        toolbar.querySelectorAll("button[data-command]").forEach(btn => {
            btn.onclick = e => { 
                e.preventDefault(); 
                const command = btn.dataset.command;
                if (command === 'showLinkModal') showLinkModal();
                else if (command === 'insertImage') imageInput.click();
                else document.execCommand(command, false, null);
                if (command !== 'showLinkModal') descContainer.focus();
            };
        });
        
        const colorPicker = document.getElementById("colorPicker");
        document.getElementById("color-btn").onclick = () => colorPicker.click();
        colorPicker.onchange = () => { document.execCommand('foreColor', false, colorPicker.value); descContainer.focus(); };

        document.getElementById("copy-prompt-btn").onclick = () => navigator.clipboard.writeText(descContainer.innerText).then(() => Toast.show("Copiato!", 'success'), () => Toast.show("Errore.", 'error'));
        document.getElementById("delete-prompt-btn").onclick = () => deletePrompt(promptItem.id);
        document.getElementById("fav-prompt-btn").onclick = async () => {
             const p = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId)?.prompts.find(pr=>pr.id===promptItem.id);
             if(p) p.favorite = !p.favorite;
             await updateStateAndSave(state.allData, { saveHistory: false });
        };
        
        descContainer.addEventListener('paste', handlePaste);
        ['dragover', 'dragleave', 'drop'].forEach(eventName => descContainer.addEventListener(eventName, e => {
            if (descContainer.contentEditable !== 'true') return;
            e.preventDefault();
            descContainer.classList.toggle('drag-over', eventName === 'dragover');
            if (eventName === 'drop' && e.dataTransfer.files.length) insertBase64Image(e.dataTransfer.files[0]);
        }));
    }
    
    function trackRecentPrompt(promptId, subId, catId) {
        state.recents = state.recents.filter(r => r.promptId !== promptId);
        state.recents.unshift({ promptId, subId, catId });
        if (state.recents.length > 20) state.recents.pop();
    }
    
    // --- DATA MANIPULATION ---
    async function addCategory() { 
        const name = window.prompt("Nome nuova categoria:"); 
        if (!name?.trim()) return;
        const newCategory = { id: `cat_${Date.now()}`, name: name.trim(), subcategories: [] }; 
        await updateStateAndSave([...state.allData, newCategory], { newActiveIds: { currentView: 'columns', activeCategoryId: newCategory.id, activeSubcategoryId: null, activePromptId: null } }); 
    }
    
    async function addSubcategory(categoryId) { 
        const name = window.prompt("Nome nuova sottocategoria:"); 
        if (!name?.trim()) return;
        const cat = state.allData.find(c => c.id === categoryId); if (!cat) return;
        const newSub = { id: `sub_${Date.now()}`, name: name.trim(), prompts: [] }; 
        cat.subcategories.push(newSub); 
        await updateStateAndSave(state.allData, { newActiveIds: { activeSubcategoryId: newSub.id, activePromptId: null } }); 
    }
    
    async function addNewPrompt(subcategoryId, categoryId) { 
        const title = window.prompt("Titolo nuovo prompt:"); 
        if (!title?.trim()) return;
        const sub = state.allData.find(c => c.id === categoryId)?.subcategories.find(s => s.id === subcategoryId); if (!sub) return;
        const newPrompt = { id: `p_${Date.now()}`, title: title.trim(), description: "", favorite: false, tags: [] }; 
        sub.prompts.push(newPrompt); 
        await updateStateAndSave(state.allData, { newActiveIds: { activePromptId: newPrompt.id }, startEditingNewPrompt: true }); 
    }
    
    async function deletePrompt(promptId) { 
        if (!window.confirm("Sei sicuro di voler eliminare questo prompt?")) return; 
        const sub = state.allData.find(c=>c.id===state.activeCategoryId)?.subcategories.find(s=>s.id===state.activeSubcategoryId); if (!sub) return;
        const pIndex = sub.prompts.findIndex(p => p.id === promptId); if (pIndex === -1) return;
        sub.prompts.splice(pIndex, 1); 
        state.recents = state.recents.filter(r => r.promptId !== promptId);
        const newActivePromptId = sub.prompts[pIndex]?.id || sub.prompts[pIndex-1]?.id || null;
        await updateStateAndSave(state.allData, { newActiveIds: { activePromptId: newActivePromptId } }); 
        Toast.show("Prompt eliminato!", 'info');
    }

    // --- TOOL FUNCTIONS ---
    function updateUndoRedoButtons() { document.getElementById('btnAnnulla').disabled = state.history.length === 0; document.getElementById('btnRipristina').disabled = state.redoStack.length === 0; }
    async function performUndo() { 
        if (state.history.length === 0) return; 
        const lastState = state.history.pop(); 
        state.redoStack.push(JSON.parse(JSON.stringify({ ...state, history: [], redoStack: [] }))); 
        Object.assign(state, lastState); 
        await Database.save(state.allData); localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents)); renderUI(); 
    }
    async function performRedo() { 
        if (state.redoStack.length === 0) return; 
        const nextState = state.redoStack.pop(); 
        state.history.push(JSON.parse(JSON.stringify({ ...state, history: [], redoStack: [] }))); 
        Object.assign(state, nextState); 
        await Database.save(state.allData); localStorage.setItem('promptManagerRecents', JSON.stringify(state.recents)); renderUI(); 
    }
    function backupData() { 
        if(state.allData.length === 0) { Toast.show("Nessun dato da esportare.", "error"); return; } 
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(state.allData, null, 2)], { type: "application/json" })); a.download = `prompts_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href); 
    }
    function importData(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
            try {
                const data = JSON.parse(ev.target.result); if (!Array.isArray(data)) throw new Error("Formato non valido");
                const first = { cat: data[0]?.id, sub: data[0]?.subcategories?.[0]?.id, p: data[0]?.subcategories?.[0]?.prompts?.[0]?.id };
                await updateStateAndSave(data, { newActiveIds: { currentView: 'columns', activeCategoryId: first.cat, activeSubcategoryId: first.sub, activePromptId: first.p }, saveHistory: false });
                state.history = []; state.redoStack = []; Toast.show("Importazione riuscita!", 'success');
            } catch (err) { Toast.show("File non valido.", 'error'); }
        };
        reader.readAsText(file); e.target.value = '';
    }
    
    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.getElementById('themeToggle').addEventListener('click', () => { 
            const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; 
            document.documentElement.setAttribute('data-theme', newTheme); 
            localStorage.setItem('theme', newTheme); 
            document.getElementById('themeToggle').innerHTML = `<i class="fa-solid fa-${newTheme === 'dark' ? 'moon' : 'sun'}"></i>`;
            updateColorPickerValue(); // Aggiorna il selettore se la toolbar è già aperta
        });
        
        categoryDropdown.addEventListener('change', () => {
            const selection = categoryDropdown.value;
            if (['favorites', 'recents', 'tags'].includes(selection)) {
                Object.assign(state, { currentView: selection, activePromptId: null, activeSubcategoryId: null, activeCategoryId: null });
            } else {
                const newCat = state.allData.find(c => c.id === selection);
                const firstSub = newCat?.subcategories.sort((a,b)=>a.name.localeCompare(b.name))[0];
                Object.assign(state, { currentView: 'columns', activeCategoryId: selection, activeSubcategoryId: firstSub?.id || null, activePromptId: firstSub?.prompts?.sort((a,b)=>a.title.localeCompare(b.title))[0]?.id || null });
            }
            renderUI();
        });
        
        imageInput.addEventListener('change', e => e.target.files.length && insertBase64Image(e.target.files[0]));
        const toolMenu = document.getElementById('toolMenu');
        document.getElementById('toolBtn').addEventListener('click', e => { e.stopPropagation(); toolMenu.classList.toggle('show'); });
        window.addEventListener('click', () => toolMenu.classList.remove('show'));
        document.getElementById('btnAddCategory').onclick = addCategory;
        document.getElementById('btnAnnulla').onclick = performUndo;
        document.getElementById('btnRipristina').onclick = performRedo;
        document.getElementById('btnBackup').onclick = backupData;
        document.getElementById('btnImporta').onclick = () => document.getElementById('backupInput').click();
        document.getElementById('backupInput').onchange = importData;

        document.getElementById('linkModalCancel').onclick = hideLinkModal;
        document.getElementById('linkModalConfirm').onclick = () => applyLink(linkUrlInput.value);
        linkModal.onclick = e => { if (e.target === linkModal) hideLinkModal(); };
        linkUrlInput.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); applyLink(linkUrlInput.value); }};

        document.getElementById('renameModalCancel').onclick = hideRenameModal;
        document.getElementById('renameModalConfirm').onclick = handleRenameConfirm;
        renameModal.onclick = e => { if (e.target === renameModal) hideRenameModal(); };
        renameInput.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); handleRenameConfirm(); } };
    }

    // --- INITIALIZATION ---
    async function initialize() {
        Loader.show();
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').innerHTML = `<i class="fa-solid fa-${savedTheme === 'light' ? 'sun' : 'moon'}"></i>`;

        await Database.init();
        state.allData = await Database.load();
        try { state.recents = JSON.parse(localStorage.getItem('promptManagerRecents')) || []; } catch (e) { state.recents = []; }

        if (state.allData.length === 0) {
            state.allData = [{ id: `cat_1`, name: 'Esempi', subcategories: [{ id: `sub_1`, name: 'Generale', prompts: [{id: `p_1`, title: 'Prompt di Benvenuto', description: 'Benvenuto! Clicca la matita in alto a destra per modificare questo prompt.', favorite: true, tags: ['tutorial']}]}]}];
            await Database.save(state.allData);
        }
        
        state.currentView = 'favorites';
        const firstFav = state.allData.flatMap(c => c.subcategories.flatMap(s => s.prompts.filter(p => p.favorite).map(p => ({catId: c.id, subId: s.id, promptId: p.id}))))[0];
        if (firstFav) Object.assign(state, { activeCategoryId: firstFav.catId, activeSubcategoryId: firstFav.subId, activePromptId: firstFav.promptId });
        
        setupEventListeners();
        renderUI();
        Loader.hide();
    }
    
    initialize();
})();
</script>
</body>
</html>
